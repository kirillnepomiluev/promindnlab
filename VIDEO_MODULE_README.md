# Модуль генерации видео

## Описание

Модуль генерации видео позволяет создавать короткие видео (5 секунд) на основе текстовых описаний с использованием API Kling.

## Функциональность

- Генерация видео длительностью 5 секунд
- Поддержка команды `/video` в текстовых сообщениях
- Поддержка голосовых команд "создай видео" или "video"
- Автоматическое списание 200 токенов за каждое видео
- Скачивание и отправка видео в Telegram

## Установка и настройка

### 1. Переменные окружения

Добавьте в файл `.env` следующие переменные:

```env
# Настройки Kling API для генерации видео
KLING_ACCESS_KEY=your_kling_access_key
KLING_SECRET_KEY=your_kling_secret_key
# Необязательный параметр: кастомный URL API Kling
KLING_API_URL=https://api.klingai.com
```

### 2. Получение API ключей Kling

1. Зарегистрируйтесь на сайте [Kling](https://kling.com)
2. Получите Access Key и Secret Key в личном кабинете
3. Добавьте Access Key в переменную окружения `KLING_ACCESS_KEY`
4. Добавьте Secret Key в переменную окружения `KLING_SECRET_KEY`

## Использование

### Текстовые команды

```
/video [описание видео]
```

Примеры:
- `/video кошка играет с мячиком`
- `/video красивый закат над морем`
- `/video анимированный логотип компании`

### Голосовые команды

Произнесите в голосовом сообщении:
- "создай видео [описание]"
- "video [описание]"

### Ответы ассистента

Если ассистент отвечает с командой `/video`, она также будет обработана автоматически.

## Стоимость

- **200 токенов** за каждое сгенерированное видео
- Проверка баланса перед генерацией
- Автоматическое списание токенов при успешной генерации

## Технические детали

### Структура модуля

```
src/video/
├── video.module.ts              # Модуль NestJS
└── video.service/
    ├── video.service.ts         # Основной сервис
    └── video.service.spec.ts    # Тесты
```

### API Kling

Модуль использует следующие параметры для генерации:
- **Эндпоинт**: `/v1/videos/text2video`
- **Модель**: kling-v1-6
- **Длительность**: 5 секунд
- **Соотношение сторон**: 1:1 (квадратное)
- **Режим**: std (стандартный)
- **Аутентификация**: JWT токены (генерируются автоматически из Access Key и Secret Key)

### Обработка ошибок

- Проверка наличия Access Key и Secret Key
- Генерация JWT токенов для каждого запроса
- Обработка ошибок сети
- Таймаут ожидания генерации (5 минут)
- Fallback отправки видео как документа при ошибках

## Интеграция с Telegram

Модуль интегрирован в `TelegramService` и поддерживает:

1. **Текстовые сообщения** с командой `/video`
2. **Голосовые сообщения** с командами "создай видео"
3. **Ответы ассистента** с командой `/video`
4. **Автоматическую проверку токенов**
5. **Отправку видео в чат**

## Логирование

Модуль ведет подробные логи:
- Начало генерации видео
- Статус обработки
- Успешное завершение
- Ошибки и их детали
- Размер скачанного видео

## Примеры использования

### Успешная генерация

```
Пользователь: /video летящий дракон
Бот: [показывает анимацию "СОЗДАЮ ВИДЕО ..."]
Бот: [отправляет сгенерированное видео с подписью "Видео по запросу: 'летящий дракон'"]
```

### Недостаточно токенов

```
Пользователь: /video красивое видео
Бот: "На Вашем балансе недостаточно токенов для генерации.
     Для продолжения работы с ботом приобретите подписку..."
```

### Ошибка генерации

```
Пользователь: /video
Бот: "Пожалуйста, укажите описание для генерации видео после команды /video"
```

## Требования

- NestJS 8+
- Node.js 16+
- Access Key и Secret Key Kling
- Достаточный баланс токенов

## Поддержка

При возникновении проблем:
1. Проверьте правильность Access Key и Secret Key
2. Убедитесь в достаточном балансе токенов
3. Проверьте логи приложения
4. Убедитесь в стабильности интернет-соединения 